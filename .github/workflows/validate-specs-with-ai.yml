name: Validate Specs with AI

on:
  push:
    branches: [todo]
    paths:
      - "openspec/**"
      - "packages/validate-specs/validate-specs-with-ai"
      - ".github/workflows/validate-specs-with-ai.yml"

jobs:
  validate-specs-with-ai:
    name: Validate Specs with AI
    runs-on: self-hosted

    outputs:
      validation-status: ${{ steps.validation.outputs.result }}
      validation-summary-json: ${{ steps.expose-validation-summary-json.outputs.validation_summary_json }}

    permissions:
      contents: read

    env:
      DIAL_KEY: ${{ secrets.DIAL_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Install dependencies
        run: bun install

      - name: Run specs validation
        run: |
          mkdir -p .specs-validation/ai
          touch .specs-validation/ai/result.json
          bun run validate-specs:ai > .specs-validation/ai/result.json

      - name: Expose validation result JSON (as base64)
        id: expose-validation-summary-json
        run: |
          SUMMARY_B64=$(base64 < .specs-validation/ai/result.json | tr -d '\n')
          echo "validation_summary_json=$SUMMARY_B64" >> "$GITHUB_OUTPUT"

      - name: Parse validation result
        id: validation
        run: |
          RESULT=$(jq -r '.result // "INVALID"' .specs-validation/ai/result.json)
          VIOLATION_COUNT=$(jq '[.violations[]?] | length' .specs-validation/ai/result.json)

          echo "result=$RESULT" >> "$GITHUB_OUTPUT"
          echo "violation_count=$VIOLATION_COUNT" >> "$GITHUB_OUTPUT"

      - name: Render validation summary
        if: always()
        run: |
          {
            echo "# üìã Specs Validation Result"
            echo ""
            echo "| Metric | Value |"
            echo "|-------|-------|"
            echo "| Result | **${{ steps.validation.outputs.result }}** |"
            echo "| Violations | ${{ steps.validation.outputs.violation_count }} |"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Render validation violations
        if: steps.validation.outputs.result != 'VALID'
        run: |
          echo "## ‚ùå Violations" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Spec | Rule | Description |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|------|-------------|" >> "$GITHUB_STEP_SUMMARY"

          jq -r '.violations[]? |
            "| \(.spec_id // "global") | \(.rule // "unknown") | \(.description // "No description") |"
          ' .specs-validation/ai/result.json >> "$GITHUB_STEP_SUMMARY"

  fix-specs-with-ai:
    name: Fix Specs with AI
    needs: validate-specs-with-ai
    if: needs.validate-specs-with-ai.outputs.validation-status == 'INVALID'
    uses: ./.github/workflows/fix-specs-with-ai.yml
    secrets: inherit
    permissions:
      contents: write
      pull-requests: write
    with:
      summary: ${{ needs.validate-specs-with-ai.outputs.validation-summary-json }}

  finally:
    name: Finalize AI-Driven Specs Validation
    needs: [validate-specs-with-ai, fix-specs-with-ai]
    runs-on: self-hosted

    steps:
      - name: Fail pipeline on failed validation
        if: needs.validate-specs-with-ai.outputs.validation-status == 'INVALID'
        run: |
          echo "‚ùå Specs validation failed! Please review the validation summary above and address the issues."
          echo "ü§ñ Or rely on the agent which already tries to fix the issues."
          exit 1
